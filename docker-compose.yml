# Deploy from tyr-infra folder / app.
# App name example: tyr-infra_pgadmin.

networks:
  # Legacy network to connect Caddy to old compose-deployed non-swarm services.
  typingrealm:
    name: typingrealm
    external: true
  # Used to access services from the internet.
  proxy:
    name: tyr-proxy-internal
    driver: overlay
    external: true
  # Used to send logs from services to infra / etc.
  infra:
    name: tyr-infrastructure-internal
    driver: overlay
    external: true
  # Used to administer services using tools like pgadmin.
  admin:
    name: tyr-administration-internal
    driver: overlay
    external: true

services:
  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=ewancoder@gmail.com
      - PGADMIN_DEFAULT_PASSWORD=qwerty123
    volumes:
      - /data/tyr-infra/pgadmin/data:/var/lib/pgadmin
    restart: unless-stopped
    networks:
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://localhost || exit 1"]
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 200m
      placement:
        constraints:
          - node.labels.dev-infra==true

  seq:
    image: datalust/seq
    user: 2000:2000
    environment:
      - ACCEPT_EULA=Y
      - SEQ_API_CANONICALURI=https://seq.typingrealm.com
      - SEQ_FIRSTRUN_ADMINPASSWORD=qwerty123
    volumes:
      - /data/tyr-infra/seq/data:/data
    restart: unless-stopped
    networks:
      proxy: {}
      infra:
        aliases:
          - seq
          - tyr-infra-seq
          - tyr-infra_seq
          - tyr-prod-infra_seq
          - tyr-dev-infra_seq
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep /seqsvr/Seq | grep -v grep || exit 1"]
    deploy:
      resources:
        limits:
          memory: 20G
        reservations:
          memory: 2G
      placement:
        constraints:
          - node.labels.dev-infra==true

  redisinsight:
    image: redis/redisinsight:latest
    user: 2000:2000
    volumes:
      - /data/tyr-infra/redisinsight/data:/data
    restart: unless-stopped
    networks:
      - proxy
      - admin
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://127.0.0.1:5540 || exit 1"]
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 200m
      placement:
        constraints:
          - node.labels.dev-infra==true

  # Production cross-service cache
  prod-cache:
    image: valkey/valkey
    user: 2000:2000
    volumes:
      - /data/tyr-infra/prod-cache/data:/data
    command: valkey-server --appendonly yes --save 60 1 --dir /data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      infra:
        aliases:
          - tyr-prod-infra_cache
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 100m
      placement:
        constraints:
          - node.labels.infra=true

  # TODO: Add ports for local development & 'internet' network.
  # Development cross-service cache
  dev-cache:
    image: valkey/valkey
    user: 2000:2000
    volumes:
      - /data/tyr-infra/dev-cache/data:/data
    command: valkey-server --appendonly yes --save 60 1 --dir /data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      infra:
        aliases:
          - tyr-dev-infra_cache
      admin: {}
    deploy:
      resources:
        limits:
          memory: 1g
        reservations:
          memory: 100m
      placement:
        constraints:
          - node.labels.dev-infra=true
